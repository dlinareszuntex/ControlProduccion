<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Boteo - Login</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
            max-width: 600px;
            width: 100%;
        }

        /* Pantallas ocultas por defecto */
        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        /* ============================================ */
        /* PANTALLA DE LOGIN */
        /* ============================================ */
        .login-screen {
            text-align: center;
        }

        .login-header {
            margin-bottom: 30px;
        }

        .login-header h1 {
            color: #2d3748;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .login-header p {
            color: #718096;
            font-size: 16px;
        }

        .login-options {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 30px;
        }

        .login-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 15px;
            padding: 30px;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 15px rgba(0,0,0,0.2);
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 20px rgba(0,0,0,0.3);
        }

        .login-btn:active {
            transform: translateY(0);
        }

        .login-btn.produccion {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }

        .login-btn.it {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
        }

        /* ============================================ */
        /* PANTALLA DE SELECCI√ìN DE OPERARIO */
        /* ============================================ */
        .operario-select-screen h2 {
            color: #2d3748;
            text-align: center;
            margin-bottom: 30px;
        }

        .operario-list {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .operario-card {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .operario-card:hover {
            background: #edf2f7;
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .operario-card.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .operario-nombre {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .operario-id {
            font-size: 14px;
            opacity: 0.7;
        }

        .btn-continuar {
            width: 100%;
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            border: none;
            border-radius: 15px;
            padding: 20px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-continuar:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-volver {
            width: 100%;
            background: #cbd5e0;
            color: #2d3748;
            border: none;
            border-radius: 15px;
            padding: 15px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }

        /* ============================================ */
        /* PANTALLA DE PRODUCCI√ìN (OPERARIO) */
        /* ============================================ */
        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #2d3748;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .operario-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .operario-info h2 {
            font-size: 28px;
            margin-bottom: 5px;
        }

        .operario-info p {
            font-size: 16px;
            opacity: 0.9;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #f7fafc;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            border: 2px solid #e2e8f0;
        }

        .stat-card.excelente {
            background: #c6f6d5;
            border-color: #48bb78;
        }

        .stat-card.normal {
            background: #bee3f8;
            border-color: #4299e1;
        }

        .stat-card.lento {
            background: #fed7d7;
            border-color: #f56565;
        }

        .stat-label {
            font-size: 14px;
            color: #718096;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #2d3748;
        }

        .stat-value.small {
            font-size: 24px;
        }

        .buttons-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 30px;
        }

        .btn {
            border: none;
            border-radius: 20px;
            padding: 40px;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 8px 15px rgba(0,0,0,0.2);
        }

        .btn:active {
            transform: scale(0.95);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-verde {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
        }

        .btn-verde:hover:not(:disabled) {
            background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);
        }

        .btn-amarillo {
            background: linear-gradient(135deg, #ecc94b 0%, #d69e2e 100%);
            color: white;
        }

        .btn-amarillo:hover:not(:disabled) {
            background: linear-gradient(135deg, #d69e2e 0%, #b7791f 100%);
        }

        .alerta-container {
            min-height: 80px;
            margin-bottom: 20px;
        }

        .alerta {
            padding: 25px;
            border-radius: 15px;
            font-size: 22px;
            font-weight: bold;
            text-align: center;
            animation: slideDown 0.3s ease;
            display: none;
        }

        .alerta.show {
            display: block;
        }

        .alerta-excelente {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
        }

        .alerta-normal {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
            color: white;
        }

        .alerta-lento {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
            color: white;
            animation: shake 0.5s;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        /* ============================================ */
        /* MODAL DE PAUSAS */
        /* ============================================ */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: #2d3748;
            font-size: 24px;
            margin-bottom: 10px;
        }

        .modal-header p {
            color: #718096;
            font-size: 16px;
        }

        .pause-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .pause-option {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
        }

        .pause-option:hover {
            background: #edf2f7;
            border-color: #ecc94b;
            transform: translateX(5px);
        }

        .pause-option-title {
            font-size: 18px;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 5px;
        }

        .pause-option-desc {
            font-size: 14px;
            color: #718096;
        }

        .modal-close {
            width: 100%;
            background: #cbd5e0;
            color: #2d3748;
            border: none;
            border-radius: 15px;
            padding: 15px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
        }

        .footer {
            text-align: center;
            color: #718096;
            font-size: 14px;
            margin-top: 20px;
        }

        .btn-logout {
            width: 100%;
            background: #fc8181;
            color: white;
            border: none;
            border-radius: 15px;
            padding: 15px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }

        /* ============================================ */
        /* PANTALLA DE IT (DASHBOARD) */
        /* ============================================ */
        .dashboard-header {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }

        .dashboard-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }

        .dashboard-controls button {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }

        .operarios-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .operario-dashboard-card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 15px;
            padding: 20px;
        }

        .operario-dashboard-card.excelente {
            border-color: #48bb78;
            background: #f0fff4;
        }

        .operario-dashboard-card.lento {
            border-color: #f56565;
            background: #fff5f5;
        }

        /* ============================================ */
        /* PANTALLA DE REPORTES */
        /* ============================================ */
        #reportesContent {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .reporte-card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 15px;
            padding: 20px;
        }

        .reporte-card h3 {
            color: #2d3748;
            margin-bottom: 15px;
            font-size: 20px;
        }

        .reporte-item {
            padding: 10px;
            margin: 5px 0;
            background: #f7fafc;
            border-radius: 8px;
            border-left: 4px solid #4299e1;
        }

        .reporte-item strong {
            color: #2d3748;
        }

        .problema-item {
            padding: 15px;
            margin: 10px 0;
            background: #fff5f5;
            border-radius: 8px;
            border-left: 4px solid #f56565;
        }

        .problema-item.warning {
            background: #fffbeb;
            border-left-color: #ecc94b;
        }

        .grafica-container {
            margin: 20px 0;
            padding: 15px;
            background: #f7fafc;
            border-radius: 10px;
        }

        .barra-grafica {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }

        .barra-grafica-label {
            width: 150px;
            font-size: 14px;
            color: #4a5568;
        }

        .barra-grafica-bar {
            flex: 1;
            height: 25px;
            background: #4299e1;
            border-radius: 5px;
            margin: 0 10px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .operario-list {
                grid-template-columns: 1fr;
            }

            .stat-value {
                font-size: 24px;
            }

            .btn {
                padding: 30px;
                font-size: 24px;
            }

            .dashboard-controls {
                flex-direction: column;
            }

            #reportesContent {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ================================================ -->
        <!-- PANTALLA 1: LOGIN -->
        <!-- ================================================ -->
        <div id="loginScreen" class="screen active">
            <div class="login-screen">
                <div class="login-header">
                    <h1>üè≠ Sistema de Boteo</h1>
                    <p>Seleccione su tipo de usuario</p>
                </div>
                <div class="login-options">
                    <button class="login-btn produccion" onclick="mostrarSeleccionOperario()">
                        üë∑ Usuario de Producci√≥n
                    </button>
                    <button class="login-btn it" onclick="loginIT()">
                        üíª Usuario IT
                    </button>
                </div>
            </div>
        </div>

        <!-- ================================================ -->
        <!-- PANTALLA 2: SELECCI√ìN DE OPERARIO -->
        <!-- ================================================ -->
        <div id="operarioSelectScreen" class="screen">
            <div class="operario-select-screen">
                <h2>Seleccione su nombre</h2>
                <div class="operario-list" id="operarioList">
                    <!-- Se llenar√° din√°micamente -->
                </div>
                <button class="btn-continuar" id="btnContinuar" onclick="iniciarSesionOperario()" disabled>
                    Continuar
                </button>
                <button class="btn-volver" onclick="volverLogin()">
                    ‚Üê Volver
                </button>
            </div>
        </div>

        <!-- ================================================ -->
        <!-- PANTALLA 3: INTERFAZ DE PRODUCCI√ìN (OPERARIO) -->
        <!-- ================================================ -->
        <div id="produccionScreen" class="screen">
            <div class="header">
                <h1>üè≠ Sistema de Boteo</h1>
            </div>

            <div class="operario-info">
                <h2 id="operarioNombre">-</h2>
                <p id="operarioDetalle">-</p>
                <p id="tareaActual">-</p>
            </div>

            <div class="stats-grid">
                <div class="stat-card" id="ciclosCard">
                    <div class="stat-label">Ciclos Hoy</div>
                    <div class="stat-value" id="ciclosHoy">0</div>
                </div>
                <div class="stat-card" id="promedioCard">
                    <div class="stat-label">Promedio (s)</div>
                    <div class="stat-value small" id="promedioTiempo">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Meta</div>
                    <div class="stat-value small">13.0s</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Eficiencia</div>
                    <div class="stat-value small" id="eficiencia">--</div>
                </div>
            </div>

            <div class="alerta-container">
                <div id="alerta" class="alerta">
                    <span id="alertaTexto"></span>
                </div>
            </div>

            <div class="buttons-container">
                <button id="btnVerde" class="btn btn-verde">
                    ‚úì TERMINADO
                </button>
                <button id="btnAmarillo" class="btn btn-amarillo">
                    ‚è∏ PAUSA
                </button>
            </div>

            <div class="footer">
                <p>√öltimo ciclo: <span id="ultimoCiclo">--</span></p>
            </div>

            <button class="btn-logout" onclick="cerrarSesion()">
                Cerrar Sesi√≥n
            </button>
        </div>

        <!-- ================================================ -->
        <!-- PANTALLA 4: DASHBOARD IT -->
        <!-- ================================================ -->
        <div id="dashboardScreen" class="screen">
            <div class="dashboard-header">
                <h1>üíª Dashboard IT</h1>
                <p>Monitoreo en Tiempo Real</p>
            </div>

            <div class="dashboard-controls">
                <input type="date" id="fechaFiltro" value="" style="flex: 1; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px;">
                <button style="background: #48bb78; color: white; flex: 1;" onclick="cargarDashboard()">
                    üîÑ Actualizar
                </button>
                <button style="background: #4299e1; color: white; flex: 1;" onclick="mostrarPantalla('reportesScreen')">
                    üìä Reportes
                </button>
                <button style="background: #fc8181; color: white; flex: 1;" onclick="cerrarSesion()">
                    Cerrar Sesi√≥n
                </button>
            </div>

            <div id="operariosGrid" class="operarios-grid">
                <!-- Se llenar√° din√°micamente -->
            </div>
        </div>

        <!-- ================================================ -->
        <!-- PANTALLA 5: REPORTES IT -->
        <!-- ================================================ -->
        <div id="reportesScreen" class="screen">
            <div class="dashboard-header">
                <h1>üìä Reportes Anal√≠ticos</h1>
                <p>An√°lisis de Productividad y Pausas</p>
            </div>

            <div class="dashboard-controls">
                <input type="date" id="fechaInicioReporte" value="" style="flex: 1; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px;">
                <input type="date" id="fechaFinReporte" value="" style="flex: 1; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px;">
                <button style="background: #48bb78; color: white; flex: 1;" onclick="cargarReportes()">
                    üîÑ Generar Reportes
                </button>
                <button style="background: #4299e1; color: white; flex: 1;" onclick="mostrarPantalla('dashboardScreen')">
                    ‚Üê Dashboard
                </button>
            </div>

            <div id="reportesContent">
                <!-- Se llenar√° din√°micamente -->
            </div>
        </div>
    </div>

    <!-- ================================================ -->
    <!-- MODAL DE PAUSAS -->
    <!-- ================================================ -->
    <div id="pausaModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚è∏ Seleccione el motivo de la pausa</h3>
                <p>Esta informaci√≥n ayuda a mejorar el proceso</p>
            </div>

            <div class="pause-options">
                <div class="pause-option" onclick="seleccionarMotivoPausa('Falla T√©cnica - M√°quina')">
                    <div class="pause-option-title">üîß Falla T√©cnica - M√°quina</div>
                    <div class="pause-option-desc">La m√°quina de costura no funciona correctamente</div>
                </div>

                <div class="pause-option" onclick="seleccionarMotivoPausa('Falla T√©cnica - L√≠nea de Producci√≥n')">
                    <div class="pause-option-title">‚öôÔ∏è Falla T√©cnica - L√≠nea</div>
                    <div class="pause-option-desc">La l√≠nea no sigue el ritmo, estaciones anteriores no terminaron</div>
                </div>

                <div class="pause-option" onclick="seleccionarMotivoPausa('Sin Materiales')">
                    <div class="pause-option-title">üì¶ Sin Materiales</div>
                    <div class="pause-option-desc">No hay materiales disponibles para continuar</div>
                </div>

                <div class="pause-option" onclick="seleccionarMotivoPausa('Ba√±o')">
                    <div class="pause-option-title">üöª Ba√±o</div>
                    <div class="pause-option-desc">Necesidad fisiol√≥gica</div>
                </div>
            </div>

            <button class="modal-close" onclick="cerrarModalPausa()">
                Cancelar
            </button>
        </div>
    </div>

    <script>
        // ============================================================================
        // CONFIGURACI√ìN GLOBAL
        // ============================================================================
        const API_URL = 'http://localhost:8000';
        
        // Estado de la aplicaci√≥n
        let appState = {
            tipoUsuario: null,  // 'produccion' o 'it'
            operarioActual: null,
            enPausa: false,
            procesando: false
        };

        // ============================================================================
        // FUNCIONES DE NAVEGACI√ìN
        // ============================================================================
        function mostrarPantalla(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function volverLogin() {
            appState = {
                tipoUsuario: null,
                operarioActual: null,
                enPausa: false,
                procesando: false
            };
            mostrarPantalla('loginScreen');
        }

        function cerrarSesion() {
            if (confirm('¬øEst√° seguro que desea cerrar sesi√≥n?')) {
                volverLogin();
            }
        }

        // ============================================================================
        // LOGIN Y SELECCI√ìN DE OPERARIO
        // ============================================================================
        async function mostrarSeleccionOperario() {
            appState.tipoUsuario = 'produccion';
            
            try {
                // Cargar lista de operarios desde el backend
                const response = await fetch(`${API_URL}/api/operarios`);
                if (!response.ok) throw new Error('Error al cargar operarios');
                
                const operarios = await response.json();
                
                const lista = document.getElementById('operarioList');
                lista.innerHTML = '';
                
                operarios.forEach(op => {
                    const card = document.createElement('div');
                    card.className = 'operario-card';
                    card.onclick = () => seleccionarOperario(op.id_operario, card);
                    card.innerHTML = `
                        <div class="operario-nombre">${op.nombre}</div>
                        <div class="operario-id">ID: ${op.id_operario}</div>
                    `;
                    lista.appendChild(card);
                });
                
                mostrarPantalla('operarioSelectScreen');
            } catch (error) {
                alert('Error al cargar operarios: ' + error.message);
            }
        }

        function seleccionarOperario(idOperario, cardElement) {
            // Deseleccionar todos
            document.querySelectorAll('.operario-card').forEach(c => c.classList.remove('selected'));
            
            // Seleccionar el actual
            cardElement.classList.add('selected');
            appState.operarioActual = idOperario;
            
            // Habilitar bot√≥n continuar
            document.getElementById('btnContinuar').disabled = false;
        }

        async function iniciarSesionOperario() {
            if (!appState.operarioActual || appState.operarioActual === null) {
                alert('Por favor seleccione un operario');
                return;
            }
            
            try {
                // Cargar m√©tricas del operario
                await cargarMetricasOperario();
                
                // Configurar event listeners de los botones
                document.getElementById('btnVerde').onclick = registrarCiclo;
                document.getElementById('btnAmarillo').onclick = abrirModalPausa;
                
                mostrarPantalla('produccionScreen');
                
                // Actualizar m√©tricas cada 30 segundos (solo si hay operario)
                if (appState.operarioActual) {
                    setInterval(() => {
                        if (appState.operarioActual) {
                            cargarMetricasOperario();
                        }
                    }, 30000);
                }
            } catch (error) {
                alert('Error al iniciar sesi√≥n: ' + error.message);
            }
        }

        // Variable global para el intervalo del dashboard
        let dashboardInterval = null;

        async function loginIT() {
            appState.tipoUsuario = 'it';
            appState.operarioActual = null; // Asegurar que no hay operario seleccionado
            
            // Limpiar intervalo anterior si existe
            if (dashboardInterval) {
                clearInterval(dashboardInterval);
                dashboardInterval = null;
            }
            
            // Inicializar fecha con hoy
            const hoy = new Date().toISOString().split('T')[0];
            const fechaFiltro = document.getElementById('fechaFiltro');
            const fechaInicioReporte = document.getElementById('fechaInicioReporte');
            const fechaFinReporte = document.getElementById('fechaFinReporte');
            
            if (fechaFiltro) fechaFiltro.value = hoy;
            if (fechaInicioReporte) fechaInicioReporte.value = hoy;
            if (fechaFinReporte) fechaFinReporte.value = hoy;
            
            await cargarDashboard();
            mostrarPantalla('dashboardScreen');
            
            // Auto-actualizar cada 10 segundos
            dashboardInterval = setInterval(cargarDashboard, 10000);
        }

        // ============================================================================
        // FUNCIONES DE PRODUCCI√ìN (OPERARIO)
        // ============================================================================
        async function cargarMetricasOperario() {
            if (!appState.operarioActual || appState.operarioActual === null || appState.operarioActual === undefined) {
                console.log('No se puede cargar m√©tricas: operarioActual es', appState.operarioActual);
                return; // No cargar si no hay operario seleccionado
            }
            
            try {
                const response = await fetch(`${API_URL}/api/metricas/${appState.operarioActual}`);
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Error al cargar m√©tricas: ${response.status} - ${errorText}`);
                }

                const data = await response.json();
                
                // Actualizar informaci√≥n del operario
                document.getElementById('operarioNombre').textContent = data.nombre;
                document.getElementById('operarioDetalle').textContent = `ID: ${data.id_operario}`;
                document.getElementById('tareaActual').textContent = `Tarea: ${data.tarea_actual}`;
                
                // Actualizar estad√≠sticas
                document.getElementById('ciclosHoy').textContent = data.ciclos_hoy;
                
                if (data.promedio_ultimos_5) {
                    document.getElementById('promedioTiempo').textContent = data.promedio_ultimos_5.toFixed(1) + 's';
                }
                
                if (data.eficiencia_porcentaje) {
                    document.getElementById('eficiencia').textContent = data.eficiencia_porcentaje.toFixed(0) + '%';
                }
                
                // Mostrar estado actual
                if (data.estado_actual && data.estado_actual !== 'Sin datos') {
                    mostrarAlerta(data.estado_actual, data.promedio_ultimos_5);
                }
                
                // Verificar si est√° en pausa
                if (data.en_pausa) {
                    appState.enPausa = true;
                }
                
            } catch (error) {
                console.error('Error al cargar m√©tricas:', error);
            }
        }

        async function registrarCiclo() {
            if (appState.procesando) return;
            if (appState.enPausa) {
                alert('Debe terminar la pausa primero');
                return;
            }

            appState.procesando = true;
            const btnVerde = document.getElementById('btnVerde');
            btnVerde.disabled = true;
            btnVerde.innerHTML = '‚è≥ Registrando...';

            try {
                const response = await fetch(`${API_URL}/api/ciclo`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        id_operario: appState.operarioActual
                    })
                });

                if (!response.ok) {
                    throw new Error(`Error: ${response.status}`);
                }

                const data = await response.json();
                
                // Actualizar UI
                actualizarEstadisticas(data);
                mostrarAlerta(data.estado, data.promedio_5_ciclos);
                actualizarUltimoCiclo(data.tiempo_ciclo_s);
                
                // Vibraci√≥n
                if (navigator.vibrate) {
                    navigator.vibrate(50);
                }

            } catch (error) {
                console.error('Error al registrar ciclo:', error);
                alert('‚ùå Error al registrar. Intente de nuevo.');
            } finally {
                appState.procesando = false;
                btnVerde.disabled = false;
                btnVerde.innerHTML = '‚úì TERMINADO';
            }
        }

        // ============================================================================
        // SISTEMA DE PAUSAS
        // ============================================================================
        function abrirModalPausa() {
            if (appState.enPausa) {
                // Si ya est√° en pausa, finalizar
                finalizarPausa();
            } else {
                // Abrir modal para seleccionar motivo
                document.getElementById('pausaModal').classList.add('show');
            }
        }

        function cerrarModalPausa() {
            document.getElementById('pausaModal').classList.remove('show');
        }

        async function seleccionarMotivoPausa(motivo) {
            cerrarModalPausa();
            
            appState.procesando = true;
            const btnAmarillo = document.getElementById('btnAmarillo');
            btnAmarillo.disabled = true;

            try {
                const response = await fetch(`${API_URL}/api/pausa`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        id_operario: appState.operarioActual,
                        accion: 'INICIO',
                        motivo: motivo
                    })
                });

                if (!response.ok) {
                    throw new Error(`Error: ${response.status}`);
                }

                const data = await response.json();
                
                appState.enPausa = true;
                btnAmarillo.innerHTML = '‚ñ∂ REANUDAR';
                btnAmarillo.style.background = 'linear-gradient(135deg, #fc8181 0%, #f56565 100%)';
                
                // Ocultar alerta mientras est√° en pausa
                document.getElementById('alerta').classList.remove('show');

                if (navigator.vibrate) {
                    navigator.vibrate([50, 50, 50]);
                }

            } catch (error) {
                console.error('Error al registrar pausa:', error);
                alert('‚ùå Error al registrar pausa');
            } finally {
                appState.procesando = false;
                btnAmarillo.disabled = false;
            }
        }

        async function finalizarPausa() {
            appState.procesando = true;
            const btnAmarillo = document.getElementById('btnAmarillo');
            btnAmarillo.disabled = true;

            try {
                const response = await fetch(`${API_URL}/api/pausa`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        id_operario: appState.operarioActual,
                        accion: 'FIN'
                    })
                });

                if (!response.ok) {
                    throw new Error(`Error: ${response.status}`);
                }

                const data = await response.json();
                
                appState.enPausa = false;
                btnAmarillo.innerHTML = '‚è∏ PAUSA';
                btnAmarillo.style.background = 'linear-gradient(135deg, #ecc94b 0%, #d69e2e 100%)';
                
                const minutos = Math.floor(data.duracion_s / 60);
                alert(`‚úì Pausa finalizada. Duraci√≥n: ${minutos} minutos`);

                if (navigator.vibrate) {
                    navigator.vibrate([50, 50, 50]);
                }

            } catch (error) {
                console.error('Error al finalizar pausa:', error);
                alert('‚ùå Error al finalizar pausa');
            } finally {
                appState.procesando = false;
                btnAmarillo.disabled = false;
            }
        }

        // ============================================================================
        // DASHBOARD IT
        // ============================================================================
        async function cargarDashboard() {
            try {
                // Obtener fecha del selector o usar hoy
                const fechaInput = document.getElementById('fechaFiltro');
                let fecha = fechaInput ? fechaInput.value : null;
                
                // Si no hay fecha, usar la fecha de hoy (en zona horaria local)
                if (!fecha) {
                    const hoy = new Date();
                    const a√±o = hoy.getFullYear();
                    const mes = String(hoy.getMonth() + 1).padStart(2, '0');
                    const dia = String(hoy.getDate()).padStart(2, '0');
                    fecha = `${a√±o}-${mes}-${dia}`;
                    if (fechaInput) fechaInput.value = fecha;
                }
                
                console.log('üîç Buscando datos para fecha:', fecha);
                
                // Si hay fecha seleccionada, usar el endpoint de resumen
                if (fecha) {
                    const response = await fetch(`${API_URL}/api/dashboard/resumen?fecha=${fecha}`);
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ detail: 'Error desconocido' }));
                        console.error('‚ùå Error al cargar dashboard:', errorData);
                        throw new Error(errorData.detail || `Error ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    console.log('‚úÖ Datos recibidos:', data);
                    
                    // Mostrar resumen general
                    const grid = document.getElementById('operariosGrid');
                    grid.innerHTML = `
                        <div style="grid-column: 1 / -1; background: white; padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                            <h2 style="color: #2d3748; margin-bottom: 15px;">Resumen General - ${data.fecha}</h2>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                                <div>
                                    <div style="font-size: 14px; color: #718096;">Operarios Activos</div>
                                    <div style="font-size: 32px; font-weight: bold; color: #2d3748;">${data.resumen_general.operarios_activos}</div>
                                </div>
                                <div>
                                    <div style="font-size: 14px; color: #718096;">Operarios Excelentes</div>
                                    <div style="font-size: 32px; font-weight: bold; color: #48bb78;">${data.resumen_general.operarios_excelentes}</div>
                                </div>
                                <div>
                                    <div style="font-size: 14px; color: #718096;">Operarios Lentos</div>
                                    <div style="font-size: 32px; font-weight: bold; color: #f56565;">${data.resumen_general.operarios_lentos}</div>
                                </div>
                                <div>
                                    <div style="font-size: 14px; color: #718096;">Ciclos Totales</div>
                                    <div style="font-size: 32px; font-weight: bold; color: #2d3748;">${data.resumen_general.ciclos_totales}</div>
                                </div>
                                <div>
                                    <div style="font-size: 14px; color: #718096;">Eficiencia Promedio</div>
                                    <div style="font-size: 32px; font-weight: bold; color: #4299e1;">${data.resumen_general.eficiencia_promedio ? data.resumen_general.eficiencia_promedio.toFixed(1) + '%' : '--'}</div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Mostrar operarios
                    data.operarios.forEach(op => {
                        const card = document.createElement('div');
                        card.className = `operario-dashboard-card ${op.estado.toLowerCase()}`;
                        
                        let estadoEmoji = 'üëç';
                        if (op.estado === 'Excelente') estadoEmoji = 'üéâ';
                        if (op.estado === 'Lento') estadoEmoji = '‚ö†Ô∏è';
                        
                        card.innerHTML = `
                            <h3>${op.nombre}</h3>
                            <p><strong>ID:</strong> ${op.id_operario}</p>
                            <p><strong>Ciclos:</strong> ${op.ciclos}</p>
                            <p><strong>Promedio:</strong> ${op.promedio ? op.promedio.toFixed(1) + 's' : '--'}</p>
                            <p><strong>Estado:</strong> ${estadoEmoji} ${op.estado}</p>
                            <p><strong>Eficiencia:</strong> ${op.eficiencia ? op.eficiencia.toFixed(1) + '%' : '--'}</p>
                            <p><strong>Pausas:</strong> ${op.pausas} (${op.tiempo_pausas_min.toFixed(0)} min)</p>
                        `;
                        
                        grid.appendChild(card);
                    });
                    
                    // Mostrar problemas detectados
                    if (data.problemas_detectados && data.problemas_detectados.length > 0) {
                        const problemasDiv = document.createElement('div');
                        problemasDiv.style.cssText = 'grid-column: 1 / -1; background: #fff5f5; padding: 20px; border-radius: 15px; border: 2px solid #f56565;';
                        problemasDiv.innerHTML = '<h3 style="color: #f56565; margin-bottom: 15px;">‚ö†Ô∏è Problemas Detectados</h3>';
                        
                        data.problemas_detectados.forEach(problema => {
                            const problemaItem = document.createElement('div');
                            problemaItem.className = 'problema-item';
                            problemaItem.innerHTML = `
                                <strong>${problema.tipo}</strong><br>
                                <span>${problema.operario}: ${problema.detalle}</span>
                            `;
                            problemasDiv.appendChild(problemaItem);
                        });
                        
                        grid.appendChild(problemasDiv);
                    }
                } else {
                    // Fallback al endpoint original
                    const response = await fetch(`${API_URL}/api/dashboard`);
                    if (!response.ok) throw new Error('Error al cargar dashboard');
                    
                    const operarios = await response.json();
                    
                    const grid = document.getElementById('operariosGrid');
                    grid.innerHTML = '';
                    
                    operarios.forEach(op => {
                        const card = document.createElement('div');
                        card.className = `operario-dashboard-card ${op.estado_actual.toLowerCase()}`;
                        
                        let estadoEmoji = 'üëç';
                        if (op.estado_actual === 'Excelente') estadoEmoji = 'üéâ';
                        if (op.estado_actual === 'Lento') estadoEmoji = '‚ö†Ô∏è';
                        
                        card.innerHTML = `
                            <h3>${op.nombre}</h3>
                            <p><strong>ID:</strong> ${op.id_operario}</p>
                            <p><strong>Ciclos:</strong> ${op.ciclos_hoy}</p>
                            <p><strong>Promedio:</strong> ${op.promedio_dia ? op.promedio_dia.toFixed(1) + 's' : '--'}</p>
                            <p><strong>Estado:</strong> ${estadoEmoji} ${op.estado_actual}</p>
                            ${op.en_pausa ? '<p style="color: #f56565;"><strong>‚è∏ EN PAUSA</strong></p>' : ''}
                        `;
                        
                        grid.appendChild(card);
                    });
                }
                
            } catch (error) {
                console.error('Error al cargar dashboard:', error);
                alert('Error al cargar dashboard: ' + error.message);
            }
        }

        // ============================================================================
        // REPORTES IT
        // ============================================================================
        async function cargarReportes() {
            try {
                const fechaInicio = document.getElementById('fechaInicioReporte').value;
                const fechaFin = document.getElementById('fechaFinReporte').value;
                
                if (!fechaInicio || !fechaFin) {
                    alert('Por favor seleccione ambas fechas');
                    return;
                }
                
                const content = document.getElementById('reportesContent');
                content.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 40px;">Cargando reportes...</div>';
                
                // Cargar reporte de pausas
                const responsePausas = await fetch(`${API_URL}/api/reportes/pausas?fecha_inicio=${fechaInicio}&fecha_fin=${fechaFin}`);
                const dataPausas = await responsePausas.json();
                
                // Cargar reporte de cuellos de botella (usar fecha fin)
                const responseCuellos = await fetch(`${API_URL}/api/reportes/cuellos-botella?fecha=${fechaFin}`);
                const dataCuellos = await responseCuellos.json();
                
                content.innerHTML = '';
                
                // Mostrar reporte de pausas
                const cardPausas = document.createElement('div');
                cardPausas.className = 'reporte-card';
                cardPausas.style.cssText = 'grid-column: 1 / -1;';
                cardPausas.innerHTML = `<h3>üìä An√°lisis de Pausas (${dataPausas.periodo})</h3>`;
                
                if (dataPausas.pausas_por_motivo && dataPausas.pausas_por_motivo.length > 0) {
                    const graficaDiv = document.createElement('div');
                    graficaDiv.className = 'grafica-container';
                    
                    dataPausas.pausas_por_motivo.forEach(pausa => {
                        const maxPausas = Math.max(...dataPausas.pausas_por_motivo.map(p => p.total_pausas));
                        const porcentaje = (pausa.total_pausas / maxPausas) * 100;
                        
                        const barra = document.createElement('div');
                        barra.className = 'barra-grafica';
                        barra.innerHTML = `
                            <div class="barra-grafica-label">${pausa.motivo}</div>
                            <div class="barra-grafica-bar" style="width: ${porcentaje}%; background: #4299e1;">
                                ${pausa.total_pausas} pausas
                            </div>
                            <div style="width: 100px; font-size: 12px; color: #718096;">
                                ${pausa.tiempo_total_min.toFixed(0)} min
                            </div>
                        `;
                        graficaDiv.appendChild(barra);
                    });
                    
                    cardPausas.appendChild(graficaDiv);
                    
                    // Mostrar recomendaciones
                    if (dataPausas.recomendaciones && dataPausas.recomendaciones.length > 0) {
                        const recomendacionesDiv = document.createElement('div');
                        recomendacionesDiv.style.cssText = 'margin-top: 20px; padding: 15px; background: #f0fff4; border-radius: 10px; border-left: 4px solid #48bb78;';
                        recomendacionesDiv.innerHTML = '<strong>üí° Recomendaciones:</strong><ul style="margin-top: 10px; padding-left: 20px;">';
                        dataPausas.recomendaciones.forEach(rec => {
                            recomendacionesDiv.innerHTML += `<li>${rec.mensaje}</li>`;
                        });
                        recomendacionesDiv.innerHTML += '</ul>';
                        cardPausas.appendChild(recomendacionesDiv);
                    }
                } else {
                    cardPausas.innerHTML += '<p>No hay datos de pausas en este periodo</p>';
                }
                
                content.appendChild(cardPausas);
                
                // Mostrar cuellos de botella
                const cardCuellos = document.createElement('div');
                cardCuellos.className = 'reporte-card';
                cardCuellos.style.cssText = 'grid-column: 1 / -1;';
                cardCuellos.innerHTML = `<h3>‚ö†Ô∏è Cuellos de Botella Detectados (${dataCuellos.fecha})</h3>`;
                
                if (dataCuellos.cuellos_botella_detectados && dataCuellos.cuellos_botella_detectados.length > 0) {
                    dataCuellos.cuellos_botella_detectados.forEach(cuello => {
                        const item = document.createElement('div');
                        item.className = 'problema-item';
                        item.innerHTML = `
                            <strong>${cuello.operario}</strong><br>
                            <span>${cuello.linea} - ${cuello.estacion}</span><br>
                            <span>Tiempo promedio: ${cuello.tiempo_promedio.toFixed(1)}s (esperado: ${cuello.tiempo_esperado.toFixed(1)}s)</span><br>
                            <span style="color: #f56565;">Retraso: ${cuello.retraso_porcentaje.toFixed(1)}%</span><br>
                            <span>${cuello.impacto_linea}</span>
                        `;
                        cardCuellos.appendChild(item);
                    });
                } else {
                    cardCuellos.innerHTML += '<p style="color: #48bb78;">‚úÖ No se detectaron cuellos de botella</p>';
                }
                
                content.appendChild(cardCuellos);
                
            } catch (error) {
                console.error('Error al cargar reportes:', error);
                alert('Error al cargar reportes: ' + error.message);
            }
        }

        // ============================================================================
        // FUNCIONES DE UI
        // ============================================================================
        function mostrarAlerta(estado, promedio) {
            const alerta = document.getElementById('alerta');
            const alertaTexto = document.getElementById('alertaTexto');
            
            alerta.classList.remove('alerta-excelente', 'alerta-normal', 'alerta-lento');
            
            let mensaje = '';
            let clase = '';
            
            switch(estado) {
                case 'Excelente':
                    mensaje = `üéâ ¬°EXCELENTE! Promedio: ${promedio ? promedio.toFixed(1) : '--'}s`;
                    clase = 'alerta-excelente';
                    break;
                case 'Normal':
                    mensaje = `üëç Buen ritmo. Promedio: ${promedio ? promedio.toFixed(1) : '--'}s`;
                    clase = 'alerta-normal';
                    break;
                case 'Lento':
                    mensaje = `‚ö†Ô∏è ATENCI√ìN: Ritmo bajo. Promedio: ${promedio ? promedio.toFixed(1) : '--'}s`;
                    clase = 'alerta-lento';
                    if (navigator.vibrate) {
                        navigator.vibrate([100, 50, 100, 50, 100]);
                    }
                    break;
            }
            
            alertaTexto.textContent = mensaje;
            alerta.classList.add(clase, 'show');
        }

        function actualizarEstadisticas(data) {
            document.getElementById('ciclosHoy').textContent = data.ciclos_completados_hoy;
            
            if (data.promedio_5_ciclos) {
                document.getElementById('promedioTiempo').textContent = data.promedio_5_ciclos.toFixed(1) + 's';
                
                const tiempoEstandar = 13.0;
                const eficiencia = (tiempoEstandar / data.promedio_5_ciclos) * 100;
                document.getElementById('eficiencia').textContent = eficiencia.toFixed(0) + '%';
            }
            
            const promedioCard = document.getElementById('promedioCard');
            promedioCard.classList.remove('excelente', 'normal', 'lento');
            
            if (data.estado === 'Excelente') {
                promedioCard.classList.add('excelente');
            } else if (data.estado === 'Normal') {
                promedioCard.classList.add('normal');
            } else if (data.estado === 'Lento') {
                promedioCard.classList.add('lento');
            }
        }

        function actualizarUltimoCiclo(tiempoSegundos) {
            if (tiempoSegundos) {
                document.getElementById('ultimoCiclo').textContent = tiempoSegundos.toFixed(1) + 's';
            }
        }

        // ============================================================================
        // INICIALIZACI√ìN
        // ============================================================================
        window.onload = () => {
            console.log('Sistema de Boteo iniciado');
        };
    </script>
</body>
</html>